<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
		xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
		xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

	<changeSet id="1" author="mbragin">
		<createTable tableName="project">
			<column name="id" type="bigserial">
				<constraints primaryKey="true" nullable="false"/>
			</column>
		</createTable>
	</changeSet>

	<changeSet id="2" author="mbragin">
		<createTable tableName="company">
			<column name="id" type="bigserial">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="name" type="varchar (500)">
				<constraints unique="true" nullable="false"/>
			</column>
			<column name="description" type="varchar"/>
			<column name="promo" type="varchar"/>
			<column name="project_id" type="bigint">
				<constraints nullable="false"/>
			</column>
		</createTable>

		<addForeignKeyConstraint baseTableName="company"
		                         baseColumnNames="project_id"
		                         constraintName="company_project_id"
		                         referencedTableName="project"
		                         referencedColumnNames="id"/>
	</changeSet>

	<changeSet id="3" author="mbragin">
		<insert tableName="project">
			<column name="id" value="0"/>
		</insert>
	</changeSet>

	<changeSet id="4" author="mbragin">
		<createTable tableName="branch">
			<column name="id" type="bigserial">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="name" type="varchar (500)">
				<constraints unique="true" nullable="false"/>
			</column>
			<column name="description" type="varchar"/>
			<column name="article" type="varchar"/>
			<column name="company_id" type="bigint">
				<constraints nullable="false"/>
			</column>
			<column name="address" type="varchar"/>
			<column name="lat" type="double precision"/>
			<column name="lon" type="double precision"/>
			<column name="office" type="varchar"/>
			<column name="currency" type="varchar"/>
			<column name="created" type="bigint"/>
			<column name="updated" type="bigint"/>
		</createTable>

		<addForeignKeyConstraint baseTableName="branch"
		                         baseColumnNames="company_id"
		                         constraintName="branch_company_id"
		                         referencedTableName="company"
		                         referencedColumnNames="id"/>
	</changeSet>

	<changeSet id="5" author="mbragin">
		<addColumn tableName="company">
			<column name="created" type="bigint"/>
			<column name="updated" type="bigint"/>
		</addColumn>
	</changeSet>

	<changeSet id="6" author="mbragin">
		<sql>
			UPDATE company SET created = 1392996233, updated = 1392996233;
			UPDATE branch SET created = 1392996233, updated = 1392996233;
		</sql>
	</changeSet>

	<changeSet id="7" author="mbragin">
		<sql>CREATE TYPE contact_type AS ENUM ('email','website', 'phone', 'fax', 'skype', 'jabber', 'twitter',
			'instagram',
			'facebook')
		</sql>
		<createTable tableName="contact">
			<column name="id" type="bigserial">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="value" type="varchar (20)">
				<constraints nullable="false"/>
			</column>
			<column name="type" type="contact_type">
				<constraints nullable="false"/>
			</column>
			<column name="comment" type="varchar (100)"/>
		</createTable>
	</changeSet>

	<changeSet id="8" author="mbragin">
		<sql>CREATE TYPE payment_option AS ENUM ('visa','mastercard', 'cash', 'american_express', 'cheque')</sql>
		<addColumn tableName="branch">
			<column name="payment_option" type="payment_option"/>
		</addColumn>
	</changeSet>

	<changeSet id="9" author="mbragin">
		<sql>DROP TABLE IF EXISTS contact</sql>

		<createTable tableName="branch_contacts">
			<column name="branch_id" type="bigint">
				<constraints nullable="false"/>
			</column>
			<column name="contact" type="contact_type">
				<constraints nullable="false"/>
			</column>
			<column name="value" type="varchar (100)">
				<constraints nullable="false"/>
			</column>
		</createTable>

		<addForeignKeyConstraint baseTableName="branch_contacts"
		                         baseColumnNames="branch_id"
		                         constraintName="branch_contacts_id"
		                         referencedTableName="branch"
		                         referencedColumnNames="id"/>
	</changeSet>

	<changeSet id="10" author="mbragin">
		<addColumn tableName="branch_contacts">
			<column name="comment" type="varchar (100)"/>
		</addColumn>
	</changeSet>


	<changeSet id="11" author="mbragin">
		<createTable tableName="rubric">
			<column name="id" type="bigserial">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="name" type="varchar (200)">
				<constraints nullable="false"/>
			</column>
			<column name="parent_id" type="bigserial"/>
		</createTable>

		<addForeignKeyConstraint baseTableName="rubric"
		                         baseColumnNames="parent_id"
		                         constraintName="rubric_parent_id"
		                         referencedTableName="rubric"
		                         referencedColumnNames="id"/>
	</changeSet>

	<changeSet id="12" author="mbragin">
		<sql>CREATE TYPE attributes_type AS ENUM ('boolean', 'number', 'range', 'string')</sql>

		<createTable tableName="attributes_group">
			<column name="id" type="bigserial">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="name" type="varchar (100)">
				<constraints nullable="false"/>
			</column>
			<column name="attributes_type" type="attributes_type">
				<constraints nullable="false"/>
			</column>
		</createTable>
	</changeSet>

	<changeSet id="13" author="mbragin">
		<createTable tableName="attribute">
			<column name="id" type="bigserial">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="name" type="varchar (100)">
				<constraints nullable="false"/>
			</column>
			<column name="group_id" type="bigint">
				<constraints nullable="false"/>
			</column>
		</createTable>

		<addForeignKeyConstraint baseTableName="attribute"
		                         baseColumnNames="group_id"
		                         constraintName="attribute_group_id"
		                         referencedTableName="attributes_group"
		                         referencedColumnNames="id"/>
	</changeSet>

	<changeSet id="14" author="mbragin">
		<addColumn tableName="attribute">
			<column name="possible_values" type="varchar"/>
		</addColumn>
	</changeSet>

	<changeSet id="15" author="mbragin">
		<createTable tableName="rubric_attributes_group">
			<column name="rubric_id" type="bigint">
				<constraints nullable="false"/>
			</column>
			<column name="attributes_group_id" type="bigint">
				<constraints nullable="false"/>
			</column>
		</createTable>

		<addForeignKeyConstraint baseTableName="rubric_attributes_group"
		                         baseColumnNames="rubric_id"
		                         constraintName="rubric_attributes_group_id"
		                         referencedTableName="rubric"
		                         referencedColumnNames="id"/>

		<addForeignKeyConstraint baseTableName="rubric_attributes_group"
		                         baseColumnNames="attributes_group_id"
		                         constraintName="attributes_group_id_attributes_group_id"
		                         referencedTableName="attributes_group"
		                         referencedColumnNames="id"/>
	</changeSet>

	<changeSet id="16" author="mbragin">
		<createTable tableName="branch_attributes">
			<column name="branch_id" type="bigint">
				<constraints nullable="false"/>
			</column>
			<column name="attribute_id" type="bigint">
				<constraints nullable="false"/>
			</column>
			<column name="value" type="varchar">
				<constraints nullable="false"/>
			</column>
		</createTable>

		<addForeignKeyConstraint baseTableName="branch_attributes"
		                         baseColumnNames="branch_id"
		                         constraintName="branch_id_branch_attributes"
		                         referencedTableName="branch"
		                         referencedColumnNames="id"/>

		<addForeignKeyConstraint baseTableName="branch_attributes"
		                         baseColumnNames="attribute_id"
		                         constraintName="attribute_id_branch_attributes"
		                         referencedTableName="attribute"
		                         referencedColumnNames="id"/>
	</changeSet>

	<changeSet id="17" author="mbragin">
		<addPrimaryKey tableName="branch_attributes"
		               columnNames="branch_id, attribute_id"
		               constraintName="pk_branch_attributes"/>

		<addPrimaryKey tableName="rubric_attributes_group"
		               columnNames="rubric_id, attributes_group_id"
		               constraintName="pk_rubric_attributes_group"/>
	</changeSet>

	<changeSet id="18" author="andpar">
		<addColumn tableName="project">
			<column name="name" type="varchar"/>
		</addColumn>
	</changeSet>

	<changeSet id="18" author="mbragin">
		<createTable tableName="branch_rubrics">
			<column name="branch_id" type="bigint">
				<constraints nullable="false"/>
			</column>
			<column name="rubric_id" type="bigint">
				<constraints nullable="false"/>
			</column>
		</createTable>

		<addForeignKeyConstraint baseTableName="branch_rubrics"
		                         baseColumnNames="branch_id"
		                         constraintName="branch_id_branch_rubrics"
		                         referencedTableName="branch"
		                         referencedColumnNames="id"/>

		<addForeignKeyConstraint baseTableName="branch_rubrics"
		                         baseColumnNames="rubric_id"
		                         constraintName="rubric_id_branch_rubrics"
		                         referencedTableName="rubric"
		                         referencedColumnNames="id"/>
	</changeSet>

	<changeSet id="19" author="mbragin">
		<addPrimaryKey tableName="branch_rubrics"
		               columnNames="branch_id, rubric_id"
		               constraintName="pk_branch_rubrics"/>
	</changeSet>

	<changeSet id="20" author="mbragin">
		<dropColumn columnName="payment_option"
		            tableName="branch"/>

		<createTable tableName="branch_payment_options">
			<column name="branch_id" type="bigint">
				<constraints nullable="false"/>
			</column>
			<column name="payment_option" type="payment_option">
				<constraints nullable="false"/>
			</column>
		</createTable>

		<addForeignKeyConstraint baseTableName="branch_payment_options"
		                         baseColumnNames="branch_id"
		                         constraintName="fk_branch_id_branch_payment_options"
		                         referencedTableName="branch"
		                         referencedColumnNames="id"/>

	</changeSet>

	<changeSet id="21" author="mbragin">
		<addColumn tableName="branch_contacts">
			<column name="id" type="bigserial">
				<constraints primaryKey="true" nullable="false"/>
			</column>
		</addColumn>
	</changeSet>

	<changeSet id="22" author="mbragin">
		<addColumn tableName="branch">
			<column name="additional_info" type="json"/>
		</addColumn>
	</changeSet>

	<!--constrains for json fields in branch table: lat, lon, contacts(check function+constraint),
	payment_options(check function+constraint)-->
	<changeSet id="23" author="mbragin">
		<sql splitStatements="false">
			ALTER TABLE branch ADD CONSTRAINT validate_point_lat CHECK
			((((additional_info->>'geometry')::json->>'point')::json->>'lat')::double precision BETWEEN -90.0 AND 90.0);
			ALTER TABLE branch ADD CONSTRAINT validate_point_lon CHECK
			((((additional_info->>'geometry')::json->>'point')::json->>'lon')::double precision BETWEEN -180.0 AND
			180.0);
			CREATE OR REPLACE FUNCTION branch_contacts_check(JSON) RETURNS boolean AS
			$BODY$
			DECLARE
			i json;
			c contact_type;
			BEGIN
			FOR i IN SELECT * FROM json_array_elements($1->'contacts')
			LOOP
			c:= (i->>'contact')::contact_type;
			END LOOP;
			RETURN true;
			EXCEPTION
			WHEN SQLSTATE '22P02' THEN
			RETURN false;
			END;
			$BODY$
			language plpgsql;

			ALTER TABLE branch ADD CONSTRAINT validate_branch_contacts CHECK (branch_contacts_check(additional_info));

			CREATE OR REPLACE FUNCTION branch_payment_options_check(JSON) RETURNS boolean AS
			$BODY$
			DECLARE
			i json;
			c payment_option;
			BEGIN
			FOR i IN SELECT * FROM json_array_elements($1->'payment_options')
			LOOP
			c:= (i->>'option')::payment_option;
			END LOOP;
			RETURN true;
			EXCEPTION
			WHEN SQLSTATE '22P02' THEN
			RETURN false;
			END;
			$BODY$
			language plpgsql;

			ALTER TABLE branch ADD CONSTRAINT validate_branch_payment_options CHECK
			(branch_payment_options_check(additional_info));
		</sql>
	</changeSet>

	<changeSet id="24" author="mbragin">
		<dropColumn tableName="branch"
		            columnName="description"/>
		<dropColumn tableName="branch"
		            columnName="address"/>
		<dropColumn tableName="branch"
		            columnName="article"/>
		<dropColumn tableName="branch"
		            columnName="lon"/>
		<dropColumn tableName="branch"
		            columnName="office"/>
		<dropColumn tableName="branch"
		            columnName="currency"/>
		<dropColumn tableName="branch"
		            columnName="lat"/>
	</changeSet>

	<changeSet author="mbragin" id="25">
		<renameColumn columnDataType="json"
		              newColumnName="data"
		              oldColumnName="additional_info"
		              tableName="branch"/>
	</changeSet>

	<changeSet author="mbragin" id="26">
		<sql>ALTER TABLE branch DROP CONSTRAINT validate_branch_payment_options;
			ALTER TABLE branch DROP CONSTRAINT validate_branch_contacts;
			ALTER TABLE branch DROP CONSTRAINT validate_point_lat;
			ALTER TABLE branch DROP CONSTRAINT validate_point_lon;

			ALTER TABLE branch ADD CONSTRAINT validate_branch_contacts CHECK (branch_contacts_check(data));
			ALTER TABLE branch ADD CONSTRAINT validate_branch_payment_options CHECK
			(branch_payment_options_check(data));
			ALTER TABLE branch ADD CONSTRAINT validate_point_lat CHECK
			((((data->>'geometry')::json->>'point')::json->>'lat')::double precision BETWEEN -90.0 AND 90.0);
			ALTER TABLE branch ADD CONSTRAINT validate_point_lon CHECK
			((((data->>'geometry')::json->>'point')::json->>'lon')::double precision BETWEEN -180.0 AND
			180.0);
		</sql>
	</changeSet>

	<changeSet author="mbragin" id="27">
		<dropTable tableName="branch_contacts"/>
		<dropTable tableName="branch_payment_options"/>
	</changeSet>

	<changeSet id="28" author="mbragin">
		<addColumn tableName="attributes_group">
			<column name="names" type="json"/>
			<column name="values" type="json"/>
			<column name="meta" type="json"/>
		</addColumn>
	</changeSet>

	<changeSet id="29" author="mbragin">
		<dropColumn tableName="attributes_group"
		            columnName="name"/>
		<dropColumn tableName="attributes_group"
		            columnName="attributes_type"/>
	</changeSet>

	<changeSet id="30" author="mbragin">
		<dropColumn tableName="attributes_group"
		            columnName="names"/>
		<dropColumn tableName="attributes_group"
		            columnName="values"/>
		<dropColumn tableName="attributes_group"
		            columnName="meta"/>
		<addColumn tableName="attributes_group">
			<column name="data" type="json"/>
			<column name="created" type="bigint">
				<constraints nullable="false"/>
			</column>
			<column name="updated" type="bigint">
				<constraints nullable="false"/>
			</column>
		</addColumn>
	</changeSet>

	<changeSet author="mbragin" id="31">
		<dropTable tableName="branch_attributes"/>
		<dropTable tableName="attribute"/>
	</changeSet>

	<changeSet id="32" author="mbragin">
		<dropColumn tableName="rubric"
		            columnName="name"/>
		<addColumn tableName="rubric">
			<column name="data" type="json"/>
			<column name="created" type="bigint">
				<constraints nullable="false"/>
			</column>
			<column name="updated" type="bigint">
				<constraints nullable="false"/>
			</column>
		</addColumn>
		<sql>ALTER TABLE rubric ADD CONSTRAINT validate_rubric_names CHECK ((data->>'names') IS NOT NULL);</sql>
	</changeSet>

	<changeSet id="33" author="mbragin">
		<createTable tableName="attribute">
			<column name="id" type="bigserial">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="data" type="json"/>
			<column name="group_id" type="bigint">
				<constraints nullable="false"/>
			</column>
			<column name="created" type="bigint">
				<constraints nullable="false"/>
			</column>
			<column name="updated" type="bigint">
				<constraints nullable="false"/>
			</column>
		</createTable>

		<addForeignKeyConstraint baseTableName="attribute"
		                         baseColumnNames="group_id"
		                         constraintName="attribute_group_id"
		                         referencedTableName="attributes_group"
		                         referencedColumnNames="id"/>
	</changeSet>

	<changeSet id="34" author="mbragin">
		<sql>ALTER TABLE rubric DROP CONSTRAINT rubric_parent_id</sql>
	</changeSet>

	<changeSet id="35" author="mbragin">
		<sql>ALTER TABLE rubric ALTER COLUMN parent_id DROP NOT NULL</sql>
		<sql>ALTER TABLE rubric ALTER COLUMN parent_id SET DATA TYPE bigint</sql>
		<sql>DROP sequence rubric_parent_id_seq CASCADE</sql>
	</changeSet>

	<changeSet id="36" author="mbragin">
		<addForeignKeyConstraint baseTableName="rubric"
		                         baseColumnNames="parent_id"
		                         constraintName="rubric_parent_id"
		                         referencedTableName="rubric"
		                         referencedColumnNames="id"/>
	</changeSet>

	<changeSet id="37" author="mbragin">
		<createTable
				catalogName="raw_data"
				tableName="data">
			<column name="id" type="bigserial">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="data" type="json"/>
		</createTable>
	</changeSet>

	<changeSet id="38" author="mbragin">
		<dropTable tableName="data"/>
		<createTable
				schemaName="raw_data"
				tableName="data">
			<column name="id" type="bigserial">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="data" type="json"/>
		</createTable>
	</changeSet>

	<changeSet id="39" author="mbragin">
		<sql>CREATE TYPE raw_data_source AS ENUM ('abrasel','4square', 'hagah')</sql>
		<addColumn tableName="data" schemaName="raw_data">
			<column name="source" type="raw_data_source"/>
		</addColumn>
	</changeSet>

    <changeSet author="mbragin" id="40">
        <sql>ALTER TABLE branch DROP CONSTRAINT validate_branch_payment_options;
        </sql>
    </changeSet>

</databaseChangeLog>